#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}Running pre-commit checks...${NC}"

# 1. Run lint-staged (ESLint + Prettier on staged files)
echo "${YELLOW}[1/4] Running lint-staged (ESLint + Prettier)...${NC}"
npx lint-staged
LINT_STAGED_EXIT=$?

if [ $LINT_STAGED_EXIT -ne 0 ]; then
  echo "${RED}❌ Lint-staged failed. Please fix the errors above.${NC}"
  exit 1
fi
echo "${GREEN}✓ Lint-staged passed${NC}"

# 2. Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# 3. Check if any JS/JSX files are staged that would affect the build
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|mjs|cjs)$' || true)

if [ -n "$JS_FILES" ]; then
  echo "${YELLOW}[2/4] Building application (JS files changed)...${NC}"
  npm run build > /dev/null 2>&1
  BUILD_EXIT=$?

  if [ $BUILD_EXIT -ne 0 ]; then
    echo "${RED}❌ Build failed. Please fix the build errors before committing.${NC}"
    npm run build  # Show the actual errors
    exit 1
  fi
  echo "${GREEN}✓ Build passed${NC}"
else
  echo "${YELLOW}[2/4] Skipping build (no JS files changed)${NC}"
fi

# 4. Run tests for changed files
TEST_FILES=$(echo "$STAGED_FILES" | grep -E '\.test\.(js|jsx)$' || true)
if [ -n "$TEST_FILES" ]; then
  echo "${YELLOW}[3/4] Running tests for changed test files...${NC}"
  npm run test:silent -- --findRelatedTests $TEST_FILES --passWithNoTests --coverageThreshold='{}'
  TEST_EXIT=$?

  if [ $TEST_EXIT -ne 0 ]; then
    echo "${RED}❌ Tests failed. Please fix the test failures before committing.${NC}"
    exit 1
  fi
  echo "${GREEN}✓ Tests passed${NC}"
else
  # Check if any source files changed that might affect tests
  SOURCE_FILES=$(echo "$STAGED_FILES" | grep -E '^(server|src)/.*\.(js|jsx)$' | grep -v '\.test\.' || true)

  if [ -n "$SOURCE_FILES" ]; then
    echo "${YELLOW}[3/4] Running related tests for changed source files...${NC}"
    npm run test:silent -- --findRelatedTests $SOURCE_FILES --passWithNoTests --coverageThreshold='{}'
    TEST_EXIT=$?

    if [ $TEST_EXIT -ne 0 ]; then
      echo "${RED}❌ Tests failed. Please fix the test failures before committing.${NC}"
      exit 1
    fi
    echo "${GREEN}✓ Tests passed${NC}"
  else
    echo "${YELLOW}[3/4] Skipping tests (no test or source files changed)${NC}"
  fi
fi

# 5. Security audit check (only if package.json or package-lock.json changed)
PACKAGE_FILES=$(echo "$STAGED_FILES" | grep -E 'package(-lock)?\.json$' || true)
if [ -n "$PACKAGE_FILES" ]; then
  echo "${YELLOW}[4/4] Running security audit (package files changed)...${NC}"
  npm audit --audit-level high > /dev/null 2>&1
  AUDIT_EXIT=$?

  if [ $AUDIT_EXIT -ne 0 ]; then
    echo "${YELLOW}⚠️  Security audit found issues. Review with 'npm audit'${NC}"
    echo "${YELLOW}Continuing with commit (audit issues should be fixed separately)${NC}"
  else
    echo "${GREEN}✓ Security audit passed${NC}"
  fi
else
  echo "${YELLOW}[4/4] Skipping security audit (no package files changed)${NC}"
fi

echo "${GREEN}✅ All pre-commit checks passed!${NC}"
exit 0
